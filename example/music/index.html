<!DOCTYPE html>
<html>
  <head>
    <title>Music</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="remotestorage-connect"></div>
    <h1>Music.</h1>
    <div id="online" style="display:none;">
      <div>
        <input id="iPath" />
        <input type="submit" value="Play!" onclick="play();" />
      </div>
      <div>
        <input onchange="localLoad(this.files);" type="file">
      </div>
    </div>
    <div id="offline">
      Please connect, using the widget.
    </div>
  </body>
  <script src="/build/0.7.0-head/remoteStorage-modules-debug.js"></script>
  <script>

    remoteStorage.onWidget('ready', function() {
      document.getElementById('offline').style.display = 'none';
      document.getElementById('online').style.display = 'block';
    });

    remoteStorage.onWidget('state', function(state) {
      if(state === 'disconnected') {
        document.getElementById('online').style.display = 'none';
        document.getElementById('offline').style.display = 'block';
      }
    });

    remoteStorage.displayWidget('remotestorage-connect');

    function getPlayer(id) {
      if(!id) {
        id = 'remotestorage-music-player';
      }
      var player = document.getElementById(id);
      if(!player) {
        player = document.createElement('audio');
        document.body.appendChild(player);
      }
      return player;
    }

    function playSong(name) {
      var player = getPlayer();
      player.src = remoteStorage.music.getSongURL(name);
      player.play();
    }

    remoteStorage.claimAccess('music', 'rw');
    function play() {
      playSong(document.getElementById('iPath').value);
    }

    function localLoad(files) {
      var fileReader = new FileReader();
      fileReader.onload = function() {
        document.getElementById('iPath').value = files[0].name;
        remoteStorage.music.storeSong(document.getElementById('iPath').value, fileReader.result);
      };
      fileReader.readAsArrayBuffer(files[0]);
    }
  </script>
</html>
